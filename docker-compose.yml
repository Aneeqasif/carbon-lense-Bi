services:
  meltano:
    build:
      context: .
      args:
        MELTANO_IMAGE: meltano/meltano:v3.7.0-python3.11
    image: carbonlens-meltano:latest
    container_name: carbonlens-meltano
    
    command: ["--help"]
    
    environment:
      # Use prod environment for Docker (MotherDuck cloud)
      MELTANO_ENVIRONMENT: prod
      # MongoDB connection - uses host.docker.internal for Docker
      TAP_MONGODB__JSONDOCS_MONGODB_CONNECTION_STRING: mongodb://admin:mongoadd99@host.docker.internal:27017/carbonLens?replicaSet=rs0&authSource=admin&directConnection=true
    
    # For host.docker.internal to work on Linux
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Sync all data from MongoDB to MotherDuck
  meltano-sync:
    extends:
      service: meltano
    container_name: carbonlens-meltano-sync
    command: ["run", "tap-mongodb--jsondocs", "target-duckdb--jsondocs", "--force"]
    profiles:
      - sync
