#+title: MongoDB → DuckDB Pipeline Demo
#+PROPERTY: header-args:duckdb :session *duckdb-demo* :format duckbox :wrap example :db output/duckdb/warehouse.duckdb
#+PROPERTY: header-args:bash :session *bash-demo* :results raw verbatim :wrap example

* Helper Functions
:PROPERTIES:
:visibility: folded
:END:

Helper to truncate long outputs:
#+NAME: head
#+begin_src emacs-lisp :var data="" :var sep="\n" :var lines=15 :exports none
  (cond
   ((stringp data) (mapconcat #'identity (seq-take (split-string data "[\n]") lines) sep))
   ((seqp data)    (seq-take data lines)))
#+end_src

* Pipeline Overview

This demo shows the MongoDB → DuckDB/MotherDuck data pipeline using Meltano.

| Component | Description                              |
|-----------+------------------------------------------|
| Source    | MongoDB (carbonLens database)            |
| Target    | DuckDB (local) / MotherDuck (cloud)      |
| Mode      | INCREMENTAL (full sync each run)         |

* Part 1: Local Environment Testing
** 1.1 Setup - Clear State & Fresh Sync

First, clear any existing state and run a fresh sync:

#+begin_src bash :async yes
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
meltano state clear dev:tap-mongodb--jsondocs-to-target-duckdb--jsondocs --force 2>/dev/null
echo "State cleared. Running fresh sync..."
meltano --environment=dev run tap-mongodb--jsondocs target-duckdb--jsondocs --force 2>&1 | grep -E "completed|record_count|error" | tail -10
#+end_src

** 1.2 Verify All Collections Loaded

Check that all 40 MongoDB collections are now in DuckDB:

#+begin_src duckdb :post head(*this*, lines=20)
SELECT table_name, table_schema 
FROM information_schema.tables 
WHERE table_schema = 'rawjd'
ORDER BY table_name;
#+end_src

** 1.3 Row Count Comparison

*** MongoDB Counts
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
print("users: " + db.users.countDocuments());
print("stationarycombustions: " + db.stationarycombustions.countDocuments());
print("sites: " + db.sites.countDocuments());
print("companies: " + db.companies.countDocuments());
print("mobilecombustions: " + db.mobilecombustions.countDocuments());
print("fugitiveemissions: " + db.fugitiveemissions.countDocuments());
'
#+end_src

*** DuckDB Counts
#+begin_src duckdb
SELECT 'users' as collection, count(*) as count FROM rawjd.users
UNION ALL SELECT 'stationarycombustions', count(*) FROM rawjd.stationarycombustions
UNION ALL SELECT 'sites', count(*) FROM rawjd.sites
UNION ALL SELECT 'companies', count(*) FROM rawjd.companies
UNION ALL SELECT 'mobilecombustions', count(*) FROM rawjd.mobilecombustions
UNION ALL SELECT 'fugitiveemissions', count(*) FROM rawjd.fugitiveemissions
ORDER BY collection;
#+end_src

** 1.4 Data Aggregation Comparison - Emissions by Fuel Type

*** MongoDB Aggregation
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
db.stationarycombustions.aggregate([
  {$group: {
    _id: "$fuelType", 
    total_emissions: {$sum: "$calculatedEmission"}, 
    count: {$sum: 1}
  }}, 
  {$sort: {count: -1}}, 
  {$limit: 5}
])'
#+end_src

*** DuckDB SQL (Same Query)
#+begin_src duckdb
SELECT 
  document->>'fuelType' as fuel_type,
  ROUND(SUM((document->>'calculatedEmission')::DOUBLE), 2) as total_emissions,
  COUNT(*) as count
FROM rawjd.stationarycombustions
GROUP BY document->>'fuelType'
ORDER BY count DESC
LIMIT 5;
#+end_src

** 1.5 Users by Role Analysis

*** MongoDB
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
db.users.aggregate([
  {$group: {_id: "$role", count: {$sum: 1}}},
  {$sort: {count: -1}}
])'
#+end_src

*** DuckDB
#+begin_src duckdb
SELECT 
  document->>'role' as role,
  COUNT(*) as count
FROM rawjd.users
GROUP BY document->>'role'
ORDER BY count DESC;
#+end_src

** 1.6 Sample Document Structure

View how MongoDB documents are stored in DuckDB:

#+begin_src duckdb
SELECT 
  object_id,
  document->>'firstName' as first_name,
  document->>'lastName' as last_name,
  document->>'email' as email,
  document->>'role' as role
FROM rawjd.users
LIMIT 5;
#+end_src

** 1.7 Total Emissions by Category

*** MongoDB - Total Emissions Across All Sources
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
var stationary = db.stationarycombustions.aggregate([{$group: {_id: null, total: {$sum: "$calculatedEmission"}}}]).toArray()[0]?.total || 0;
var mobile = db.mobilecombustions.aggregate([{$group: {_id: null, total: {$sum: "$calculatedEmission"}}}]).toArray()[0]?.total || 0;
var fugitive = db.fugitiveemissions.aggregate([{$group: {_id: null, total: {$sum: "$calculatedEmission"}}}]).toArray()[0]?.total || 0;
print("Stationary Combustion: " + stationary.toFixed(2));
print("Mobile Combustion: " + mobile.toFixed(2));
print("Fugitive Emissions: " + fugitive.toFixed(2));
print("TOTAL: " + (stationary + mobile + fugitive).toFixed(2));
'
#+end_src

*** DuckDB - Same Calculation
#+begin_src duckdb
SELECT 'Stationary Combustion' as source, 
       ROUND(SUM((document->>'calculatedEmission')::DOUBLE), 2) as total_emissions
FROM rawjd.stationarycombustions
UNION ALL
SELECT 'Mobile Combustion', 
       ROUND(SUM((document->>'calculatedEmission')::DOUBLE), 2)
FROM rawjd.mobilecombustions
UNION ALL
SELECT 'Fugitive Emissions', 
       ROUND(SUM((document->>'calculatedEmission')::DOUBLE), 2)
FROM rawjd.fugitiveemissions;
#+end_src

** 1.8 Live Changes Demo - Insert, Sync, Verify

This section demonstrates that changes in MongoDB are captured by the pipeline.

*Note:* INCREMENTAL mode syncs all data but doesn't auto-delete removed records.
This is standard behavior for data pipelines to preserve audit trails.

*** Step 1: Check current state (before insert)
#+begin_src bash
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
uv run scripts/test_insert_data.py --count
#+end_src

*** Step 2: Insert 3 test records into MongoDB
#+begin_src bash
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
uv run scripts/test_insert_data.py --insert
#+end_src

*** Step 3: Verify MongoDB count increased
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
print("stationarycombustions count: " + db.stationarycombustions.countDocuments());
print("Test records (DEMO_TEST): " + db.stationarycombustions.countDocuments({source: "DEMO_TEST"}));
'
#+end_src

*** Step 4: Clear state and run sync to capture changes
#+begin_src bash :async yes
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
meltano state clear dev:tap-mongodb--jsondocs-to-target-duckdb--jsondocs --force 2>/dev/null
meltano --environment=dev run tap-mongodb--jsondocs target-duckdb--jsondocs --force 2>&1 | grep -E "completed|stationarycombustions|record_count" | tail -5
#+end_src

*** Step 5: Verify DuckDB now has the test records
#+begin_src duckdb
SELECT 
  object_id,
  document->>'source' as source,
  document->>'year' as year,
  document->>'month' as month,
  document->>'equipment' as equipment,
  ROUND((document->>'calculatedEmission')::DOUBLE, 2) as emissions
FROM rawjd.stationarycombustions
WHERE document->>'source' = 'DEMO_TEST'
ORDER BY document->>'month';
#+end_src

*** Step 6: Cleanup - Delete test records from both MongoDB and DuckDB
#+begin_src bash
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
uv run scripts/test_insert_data.py --delete
duckdb output/duckdb/warehouse.duckdb -c "DELETE FROM rawjd.stationarycombustions WHERE document->>'source' = 'DEMO_TEST';"
echo "Cleanup complete!"
#+end_src

*** Step 7: Verify cleanup - no test records remain
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
print("MongoDB test records: " + db.stationarycombustions.countDocuments({source: "DEMO_TEST"}));
'
#+end_src

#+begin_src duckdb
SELECT COUNT(*) as duckdb_test_count
FROM rawjd.stationarycombustions
WHERE document->>'source' = 'DEMO_TEST';
#+end_src

** 1.9 Create BI-Ready Views & Analytics

This section creates analytical views on top of raw data and demonstrates
that DuckDB and MongoDB produce identical aggregation results.

*** Step 1: Run view creation script
#+begin_src bash
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
duckdb output/duckdb/warehouse.duckdb < scripts/01_create_all_views.sql 2>&1 | tail -10
#+end_src

*** Step 2: List all created views
#+begin_src duckdb
SELECT table_name as view_name
FROM information_schema.tables 
WHERE table_type = 'VIEW' AND table_schema = 'rawjd'
ORDER BY table_name;
#+end_src

*** Step 3: Emissions by Year (2025) - DuckDB vs MongoDB

**** DuckDB Query
#+begin_src duckdb
SELECT year, 
       ROUND(SUM(calculated_emission), 2) as total_emissions, 
       COUNT(*) as records 
FROM rawjd.v_current_stationarycombustions 
WHERE year = '2025'
GROUP BY year;
#+end_src

**** MongoDB Query (Same Result)
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
db.stationarycombustions.aggregate([
  {$match: {year: "2025"}}, 
  {$group: {_id: "$year", total_emissions: {$sum: "$calculatedEmission"}, records: {$sum: 1}}}
])'
#+end_src

*** Step 4: Total Emissions by Scope - DuckDB
#+begin_src duckdb
SELECT scope, 
       ROUND(SUM(total_emission_tco2e), 2) as total_emissions,
       SUM(record_count) as records
FROM rawjd.v_emissions_summary_by_scope
GROUP BY scope
ORDER BY scope;
#+end_src

*** Step 5: Emissions by Site - DuckDB vs MongoDB

**** DuckDB Query (with JOIN)
#+begin_src duckdb
SELECT s.site_name, 
       ROUND(SUM(sc.calculated_emission), 2) as emissions, 
       COUNT(*) as records 
FROM rawjd.v_current_stationarycombustions sc 
JOIN rawjd.v_current_sites s ON sc.site_id = s._id 
GROUP BY s.site_name 
ORDER BY emissions DESC;
#+end_src

**** MongoDB Query (with $lookup)
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
db.stationarycombustions.aggregate([
  {$lookup: {from: "sites", localField: "siteId", foreignField: "_id", as: "site"}}, 
  {$unwind: "$site"}, 
  {$group: {_id: "$site.siteName", emissions: {$sum: "$calculatedEmission"}, records: {$sum: 1}}}, 
  {$sort: {emissions: -1}}
])'
#+end_src

*** Step 6: Emissions by Year (All Years) - Comparison

**** DuckDB
#+begin_src duckdb
SELECT year, 
       ROUND(SUM(calculated_emission), 2) as total_emissions, 
       COUNT(*) as records 
FROM rawjd.v_current_stationarycombustions 
GROUP BY year 
ORDER BY year DESC;
#+end_src

**** MongoDB
#+begin_src bash
mongosh "mongodb://admin:mongoadd99@localhost:27017/carbonLens?authSource=admin" --quiet --eval '
db.stationarycombustions.aggregate([
  {$group: {_id: "$year", total_emissions: {$sum: "$calculatedEmission"}, records: {$sum: 1}}}, 
  {$sort: {_id: -1}}
])'
#+end_src

*** Step 7: Sample View Data - Users
#+begin_src duckdb
SELECT _id, name, email, role 
FROM rawjd.v_current_users 
LIMIT 5;
#+end_src

*** Step 8: Sample View Data - Sites
#+begin_src duckdb
SELECT _id, site_name, country, sector_type 
FROM rawjd.v_current_sites;
#+end_src

* Part 2: Docker + MotherDuck (Production)
** 2.1 Build Docker Image

#+begin_src bash :async yes
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
docker compose build meltano 2>&1 | tail -5
#+end_src

** 2.2 Run Production Sync to MotherDuck

#+begin_src bash :async yes
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
docker compose --profile sync run --rm meltano-sync 2>&1 | grep -E "completed|record_count|error|METRIC" | tail -15
#+end_src

** 2.3 Verify Data in MotherDuck

Connect to MotherDuck and check the data:

#+begin_src bash :post head(*this*, lines=15)
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
TOKEN=$(grep MOTHERDUCK_TOKEN meltano.yml | head -1 | awk '{print $2}')
duckdb "md:carbonlensmd?motherduck_token=$TOKEN" -c "
SELECT table_name, table_schema 
FROM information_schema.tables 
WHERE table_schema = 'rawjd'
ORDER BY table_name;
"
#+end_src

** 2.4 MotherDuck Row Counts

#+begin_src bash
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
TOKEN=$(grep MOTHERDUCK_TOKEN meltano.yml | head -1 | awk '{print $2}')
duckdb "md:carbonlensmd?motherduck_token=$TOKEN" -c "
SELECT 'users' as tbl, count(*) FROM rawjd.users
UNION ALL SELECT 'stationarycombustions', count(*) FROM rawjd.stationarycombustions
UNION ALL SELECT 'sites', count(*) FROM rawjd.sites
UNION ALL SELECT 'companies', count(*) FROM rawjd.companies
ORDER BY tbl;
"
#+end_src

** 2.5 MotherDuck Emissions Aggregation

#+begin_src bash
cd /home/aneeq/Documents/Fiver/react-dashboard/CL_site/mongo-pg
TOKEN=$(grep MOTHERDUCK_TOKEN meltano.yml | head -1 | awk '{print $2}')
duckdb "md:carbonlensmd?motherduck_token=$TOKEN" -c "
SELECT 
  document->>'fuelType' as fuel_type,
  ROUND(SUM((document->>'calculatedEmission')::DOUBLE), 2) as total_emissions,
  COUNT(*) as count
FROM rawjd.stationarycombustions
GROUP BY 1
ORDER BY count DESC
LIMIT 5;
"
#+end_src

* Part 3: Quick Reference
** Useful Commands

| Action      | Command                                                                           |
|-------------+-----------------------------------------------------------------------------------|
| Local sync  | =meltano --environment=dev run tap-mongodb--jsondocs target-duckdb--jsondocs --force= |
| Docker sync | =docker compose --profile sync run --rm meltano-sync=                             |
| Clear state | =meltano state clear dev:tap-mongodb--jsondocs-to-target-duckdb--jsondocs --force=    |
| Check state | =meltano state list=                                                              |

** Environment Details

| Environment | Target             | Database                        |
|-------------+--------------------+---------------------------------|
| dev         | Local DuckDB       | =output/duckdb/warehouse.duckdb=  |
| prod        | MotherDuck Cloud   | =md:carbonlensmd=                 |

* Summary

✅ 40 MongoDB collections synced to DuckDB
✅ 19 BI-ready views created for analytics
✅ Data integrity verified (counts and aggregations match)
✅ Works locally and in Docker with MotherDuck
✅ INCREMENTAL mode ensures reliable full data sync
✅ Live changes demo: insert → sync → verify → cleanup
